{% from 'user_macros.html' import intention %}
{% extends "layout.html" %}
{% block css %}
    {% assets "user_css" %}
        <link rel="stylesheet" href="{{ ASSET_URL }}">
        <script src="https://use.fontawesome.com/a911e2def4.js"></script>
    {% endassets %}

    <style>
        .picker__date-display {
            background-color: white;
            color: #d24141 !important;
        }

        .picker__footer {
            display: none !important;
        }

        .picker__holder {
            position: static !important;
            border: 0 !important;
        }

        .picker__month-display {
            font-size: 1rem;
        }

        .picker__day-display {
            font-size: 2em;
        }

        .picker__year-display {
            font-size: 2em;
            color: #d24141 !important;
        }

        .datepicker {
            display: none !important;
        }

        .picker {
            font-size: 14px !important;
        }

        .picker__box {
            border: none;
            box-shadow: none;
        }

        .picker__wrap {
            margin-top: 50px !important;
        }

        .picker__table {
            font-size: 0.8rem;
        }
        .picker__header {
            /*margin-left: 38px !important;*/
        }

        .picker__weekday-display {
            display: none !important;
        }

        .picker__day--selected {
            background-color: #d24141 !important;
        }
    </style>
{% endblock %}
{% block content %}
        <h2 class="en-tete" style="background-color: #d24141"><img src="{{url_for('static', filename='img/ampoule-idee.png')}}">J'agis</h2>        
        <div class="boxed-layout">
        <div class="row">
            <div class="col s12">
                <ul class="tabs">
                    <li class="tab col s4"><a class="active" href="#actions">Passer à l'action</a></li>
                    <li class="tab col s4"><a href="#test2">Recherche une action</a></li>
                    <li class="tab col s4"><a href="#create">Créer une action</a></li>
                </ul>
                </div>
                <div id="actions" class="col s12">
                    <div class="row">
                        <div class="col s3">
                            <input class="datepicker"/>    
                        </div>
                        <div class="col s9">
                            <div id="actions-card">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="test2" class="col s12">Test 2</div>
                <div id="create" class="col s12" style="padding: 0 25%">
                    <h6>Je définis mon action</h6>
                    <div class="row">
                        <div class="title-with-bullet">Son intitulé</div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                          <input id="title" type="text">
                          <label class="active" for="first_name2">Son intitulé</label>
                        </div>
                    </div>
                    <div class="row">
                    <div class="title-with-bullet">Sa description</div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                          <textarea id="description" class="materialize-textarea" rows="10"></textarea>
                          <label class="active" for="description">Sa description</label>
                        </div>
                    </div>
                </div>
        </div>
        </div>
{% endblock %}

{% block js %}
    <script src="{{url_for('static', filename='libs/moment/min/moment.min.js')}}"></script>
    <script src="{{url_for('static', filename='js/require.js')}}"></script>
    <script src="{{url_for('static', filename='libs/hyperscript/bundle.js')}}"></script>

    <script>
        $(document).ready(function() {
            var h = require('hyperscript');
            var hh = require('hyperscript-helpers')(h);

            var div  = hh.div,
                span = hh.span,
                h1   = hh.h1
                p    = hh.p,
                a    = hh.a
                strong = hh.strong
                ul = hh.ul
                li = hh.li
                img = hh.img
                i = hh.i
                input = hh.input,
                form = hh.form;

            var $input = $('.datepicker').pickadate({
                klass: {
                    picker: "picker picker--opened",
                    opened: "__always-open__"
                },
                onSet: function() {
                    setState({selectedDate: this.get('select', 'yyyy-mm-dd')});
                    filteredActions = state.actions.filter(action => 
                        (action.dates || []).includes(state.selectedDate)
                    );
                    refreshActions(filteredActions);
                }
            });
            var state = {};

            function setState(object) {
                state = Object.assign({}, state, object);
            }

            function sideNavNode(action) {
                return div({style: {'padding': '0 10%'}}, [
                    div('.row', [
                        p({style:{'text-transform': 'uppercase', 'font-weight': 'bold', 'color': '#d24141'}}, [
                            div({style: {'border-radius': '100%', 'height' : '43px', 'width': '43px', 'background-color': '#d24141', 'color': 'white', 'display': 'inline-block', 'margin-right' : '10px'}}, [
                                span('.fa.fa-handshake-o.fa-2x', {style: {'position': 'relative', 'top': '8px', 'left': '5px'}})
                            ])
                        ], 'Donner/Recevoir')
                    ]),
                    div('.row', [
                        p({style:{'text-align': 'center', 'font-weight': 'bold', 'font-size': '20px'}}, action.title)
                    ]),
                    div('.row'),  [
                        div('.col.s12', [
                            ul('.tabs', [
                                li('.tab.col.s3', [
                                    a('.active', {'href': '#description-tab'}, 'description')
                                ]),
                                li('.tab.col.s3', [
                                    a({'href': '#participants-tab'}, 'participants')
                                ]),
                                li('.tab.col.s3', [
                                    a({'href': '#commentaires-tab'}, 'commentaires')
                                ]),
                                li('.tab.col.s3', [
                                    a({'href': '#ressources-tab'}, 'ressources')
                                ])
                            ])
                        ]),
                        div('#description-tab.col.s12', {style: {'padding-top': '50px'}}, [
                            // description
                            div('.row', [
                                div('.title-with-bullet', 'Sa description')
                            ]),
                            div('.row', action.description),

                            // duration with slider
                            div('.row', [
                                div('.title-with-bullet', 'Sa durée')
                            ]),
                            div('.row', [
                                form({
                                  "attributes": {
                                    "action": "#"
                                  }
                                }, [
                                  p(".range-field", [
                                    input({
                                        type: "range",
                                        min: "0",
                                        max: "100"
                                    })
                                  ])
                                ])
                            ]),
                            div('.row', {style: {'margin-top': '-27px'}}, [
                                div('.col.s3', {style: {'position': 'relative', 'right': '47px'}}, 'Action coup de point'),
                                div('.col.s3', {style: {'position': 'relative', 'right': '20px'}}, 'Je prends la température'),
                                div('.col.s3', {style: {'position': 'relative', 'left': '20px'}}, 'J\'ancre une habitude'),
                                div('.col.s3', {style: {'position': 'relative', 'left': '47px'}}, 'Je m\'engage à long terme')
                            ])
                        ]),
                        div('#participants-tab.col.s12', 'Toto part en vacances'),
                        div('#commentaires-tab.col.s12', 'Hello world'),
                        div('#ressources-tab.col.s12', 'A lot of ressources goes here')
                    ]
                ]);
            }

            function cardNode(action) {
                var buttonText = "Réalisé";
                return ( 
                    div('.card', [
                        div('.card-content.white-text', [
                            div('.row', [
                                div('.col.s1', [
                                    span('.fa.fa-user.fa-3x')
                                ]),
                                div('.col.s1.offset-s4', [
                                    span('.fa.fa-user-circle.fa-3x', {style: {'color': '#d24141', 'position':'relative', 'left': '-15px'}})
                                ]),
                                div('.col.s1.offset-s4', [
                                    span('.fa.fa-user.fa-3x')
                                ])
                            ]),
                            div('.row', [
                                p({style: {'text-align': 'center', 'font-weight': 'bold', 'color': '#d24141'}}, 'Donner/Recevoir')
                            ]),
                            p('.card-title.button-collapse', {onclick: function(e) {
                                    if (!document.getElementById('slide-out-actions')) {
                                        var node2 = div("#slide-out-actions.side-nav");
                                        document.body.appendChild(node2);
                                    }
                                    //renderTo('slide-out-actions', p(action.description));
                                    //document.getElementById('slide-out-actions')..appendChild(node);
                                    var node = sideNavNode(action);
                                    console.log(node);
                                    renderTo('slide-out-actions', node);
                                    $(this).attr('data-activates', 'slide-out-actions');
                                    $(this).sideNav({
                                   // $('#test-sidenav').sideNav({
                                      menuWidth: 700, // Default is 300
                                      edge: 'right', // Choose the horizontal origin
                                      closeOnClick: false, // Closes side-nav on <a> clicks, useful for Angular/Meteor
                                      draggable: true // Choose whether you can drag to open on touch screens
                                    });
                                    $(this).sideNav('show');
                                    $('ul.tabs').tabs();
  
                            }, style: {'color': 'black', 'text-align':'center', 'cursor': 'pointer'}}, action.title),
                            p({style: {'color': 'black', 'padding-top': '20px', 'text-align': 'center'}}, [
                                strong(220)
                                ], ' personnes participent')
                            ]
                        ),
                        div('.card-action', {}, [
                            p({style: {'text-align': 'center'}}, [
                                a(".bouton-rond",  {href: "#", style:{'color': 'black',  'margin-right': '0'}}, buttonText)

                                ])
                            ]
                        )
                    ])
                );             
            }

            function partitionList(input, spacing) {
               var output = [];

                for (var i = 0; i < input.length; i += spacing) {
                    output[output.length] = input.slice(i, i + spacing);
                }
                return output;
            }

            function actionsList(actions) {
                return div('', {}, 
                    partitionList(actions, 4).map(subactions => 
                        div(".row", {style: {'margin-top': '50px !important'}}, subactions.map(action => 
                            div('.col.s4',  {}, cardNode(action))
                        ))
                    )
                );
            }

            function renderTo(id_, node) {
                var target = document.getElementById(id_);
                var fc = target.firstChild;
                while(fc) {
                    target.removeChild(fc);
                    fc = target.firstChild;
                }
                target.appendChild(node);
            }

            function refreshActions(actions) {
                renderTo('actions-card', actionsList(actions));
            }

            $.getJSON('/users/actions/get', function(data) {
                setState({actions: data});
                refreshActions(state.actions.filter(action => 
                        (action.dates || []).includes(moment().format('YYYY-MM-DD'))
                    )
                );
            });
    });

    </script>

{% endblock %}